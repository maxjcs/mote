/*! Created by Feil.Wang(wangfeilong@xuexibao.cn) on 2015.06.19 */
!function(a,e,i){"use strict";a.vm=e.define({$id:"appCtrl",initialized:!1,qaVo:{}}),e.scan();var d={getQaDetailInfo:function(a){i.ajax({method:"post",dataType:"json",url:WEB_SERVER+"api/question/shareAudioDetail",data:{teacherId:Params.teacherId,questionId:Params.questionId},success:function(e){console.log(e),a(e)}})}};d.getQaDetailInfo(function(a){vm.qaVo=a.data,2!=vm.qaVo.audioType&&o("audioPlayer",vm.qaVo.audioUrl),vm.initialized=!0}),i(function(){FastClick.attach(document.body),i("#showMoreBtn").on("click",function(){var a=i(this),e=i("#qaContent");a.hasClass("unfold")?(e.removeClass("more"),a.removeClass("unfold").children("span").text("显示全部")):(e.addClass("more"),a.addClass("unfold").children("span").text("收起"))}),i("#playerShowBtn").on("click",function(){2==vm.qaVo.audioType?confirm("请下载学习宝客户端观看白板讲解")&&(window.location.href="http://www.xuexibao.cn/html/download.html"):(i(this).siblings(".play-ani").css("display","inline-block"),i(this).hide(),i(".audio-player-wrapper").removeClass("hide"))})});var o=function(a,e){return this instanceof o?(this.audioPlayer=i("#"+a),this.audioUrl=e,this.elem={},this.isCanplay=!1,void this.init()):new o(a,e)};o.prototype={constructor:o,init:function(){var a=this;a.createPlayer(),a.elem={audioTrack:a.audioPlayer.children("audio")[0],playhead:a.audioPlayer.find(".progress"),loaded:a.audioPlayer.find(".loaded"),playedTime:a.audioPlayer.find(".played"),duration:a.audioPlayer.find(".duration"),playbtn:a.audioPlayer.find(".play-pause")},a.bufferBar(),a.bindEvent()},createPlayer:function(){var a=this,e='<audio src="'+a.audioUrl+'" preload="none"></audio><div class="player-left"><div class="scrubber"><div class="progress"></div><div class="loaded"></div></div><div class="time"><em class="played">00:00</em>/<strong class="duration">00:00</strong></div><div class="error-message"></div></div><div class="play-pause"><p class="play"></p><p class="pause"></p><p class="loading"></p><p class="error"></p></div>';a.audioPlayer.html(e)},playPause:function(){var a=this;a.elem.audioTrack.paused?(a.elem.audioTrack.play(),a.audioPlayer.addClass("playing"),a.isCanplay||a.audioPlayer.addClass("loading")):(a.elem.audioTrack.pause(),a.audioPlayer.removeClass("playing"))},updatePlayhead:function(){var a=this,e=a.elem.audioTrack.currentTime/a.elem.audioTrack.duration*100+"%";a.elem.playhead.width(e),a.elem.playedTime.html(a.formatTime(a.elem.audioTrack.currentTime)),isNaN(a.elem.audioTrack.duration)||a.elem.duration.html(a.formatTime(a.elem.audioTrack.duration))},bufferBar:function(){var a=this,e=setInterval(function(){var i=a.elem.audioTrack.buffered.length;if(i>0&&void 0!=a.elem.audioTrack.buffered){var d=a.elem.audioTrack.buffered.end(i-1)/a.elem.audioTrack.duration;a.elem.loaded.width(100*d+"%"),Math.abs(a.elem.audioTrack.duration-a.elem.audioTrack.buffered.end(i-1))<1&&(a.elem.loaded.width("100%"),clearInterval(e))}},1e3)},bindEvent:function(){var a=this;i(a.elem.audioTrack).on({timeupdate:function(){a.updatePlayhead()},canplay:function(){a.isCanplay=!0,a.audioPlayer.removeClass("loading")},playing:function(){i(".play-ani").removeClass("play-ani-pasue")},pause:function(){i(".play-ani").addClass("play-ani-pasue")},ended:function(){a.audioPlayer.removeClass("playing")}}),a.elem.playbtn.on("click",function(){a.playPause()})},formatTime:function(a){var e=parseInt(a%60),i=parseInt(a/60%60);return e=e>=10?e:"0"+e,i=i>=10?i:"0"+i,i+":"+e}}}(window,avalon,Zepto);