/*! Created by Feil.Wang(wangfeilong@xuexibao.cn) on 2015/6/29. */
!function(e,o,a){"use strict";function s(e){var a=o.filters.escape(e.content),s=o.filters.dateDiff(e.createTime),t='<li class="clearfix">    <p class="user-avatar">        <img src="'+(teacherHome.teacherInfo.avatarUrl||root.defaultAvatarUrl)+'">    </p>    <dl>       <dt><span class="user-name">'+teacherHome.teacherInfo.nickname+'</span><i class="icon icon-sex '+(1==teacherHome.teacherInfo.gender?"icon-male":"icon-female")+'"></i>           <span class="time">'+s+'</span></dt>       <dd class="msg-content">'+a+"</dd>    </dl></li>";return t}function t(e){a("#gbMsgList").prepend(s(e)),guessbook.gbCount+=1}var n=Util.getUrlParam("teacherId");e.root=o.define({$id:"root",pageTitle:"",defaultAvatarUrl:WEB_SERVER+"/static/images/default-avatar@2x.png",initialized:!1}),e.teacherHome=o.define({$id:"teacherHome",teacherId:n,teacherInfo:{},showMore:function(){var e=a(this);e.hasClass("hasmore")&&e.toggleClass("ellipsis")}}),e.workbook=o.define({$id:"workbook",wbList:[],wbItemDetail:function(o){console.log("跳转到习题集详情：",o),e.external.workbookDetail(o)},pageNo:0,moreWorkbook:function(){workbook.pageNo++,i.getWorkBookList(workbook.pageNo,function(e){workbook.wbList=workbook.wbList.concat(e.data),console.log("加载更多习题集：",workbook.wbList)})}}),e.guessbook=o.define({$id:"guessbook",gbCount:"",gbList:[],pageNo:1,isLoading:!1,isLastPage:!1,moreLeaveMsg:function(){guessbook.isLoading||(guessbook.isLoading=!0,guessbook.pageNo++,i.getLeaveMessages(guessbook.pageNo,function(e){var o=Math.ceil(e.data.teacherMessageCount/10);console.log("当前页：",guessbook.pageNo,"总页数：",o),guessbook.pageNo==o&&(guessbook.isLastPage=!0);for(var a=guessbook.gbList,s=e.data.teacherMessage,t=e.data.teacherMessage,n=0;n<s.length;n++)for(var i=0;i<a.length;i++)a[i].id==s[n].id&&t.splice(n,1);guessbook.gbList.pushArray(t),guessbook.isLoading=!1}))}}),o.scan(document.body);var i={getTeacherInfo:function(){a.ajax({method:"post",dataType:"json",data:{teacherId:n},url:API_SERVER+"/api/user/getTeacherById",success:function(o){console.log("基本信息：",o),o.success?(root.initialized=!0,o.data?(root.pageTitle=o.data.isOrg?o.data.nickname:o.data.nickname+"老师",teacherHome.teacherInfo=o.data,Util.ellipsis()):a(document.body).html('<div class="error-layer"><p>该教师不存在！</p></div>'),e.external.hideLoading()):e.external.errorTips("基本信息加载失败！")}})},getWorkBookList:function(o,s){a.ajax({method:"post",dataType:"json",url:API_SERVER+"/api/audioset/listAudioSetByTeacherId",data:{teacherId:n,pageNo:o},success:function(o){console.log("习题集：",o),o.success?s(o):e.external.errorTips("习题集加载失败！")}})},getLeaveMessages:function(o,s){a.ajax({method:"post",dataType:"json",url:API_SERVER+"/api/teacherMessage/getTeacherMessageForH5",data:{teacherId:n,pageNo:o},success:function(o){console.log("留言：",o),o.success?s(o):e.external.errorTips("留言加载失败！")}})}};i.getTeacherInfo(),i.getLeaveMessages(1,function(e){guessbook.gbCount=e.data.teacherMessageCount,guessbook.gbList=e.data.teacherMessage,guessbook.gbCount<=10&&(guessbook.isLastPage=!0)}),i.getWorkBookList(0,function(e){workbook.wbList=e.data,Util.clipWbTxt()}),e.jsInvoke=function(e,o){switch(console.log(e,":",o),e){case"sendLeaveMessage":t(o);break;default:console.warn("externalMessage: type -"+e+" is unknown",o)}},a(function(){e.external.hideLoading()})}(window,avalon,Zepto);