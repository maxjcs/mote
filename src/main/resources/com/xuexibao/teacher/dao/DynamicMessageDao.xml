<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xuexibao.teacher.dao.DynamicMessageDao">
	<select id="loadDynamicMessage" resultType="DynamicMessage" parameterType="Long">
		<![CDATA[
			select *
			from teacher_dynamic_message 
			where id=#{value}
		 ]]>
	</select>

	<select id="listDynamicMessage" resultType="DynamicMessage" parameterType="map">
		<![CDATA[
			select *
			from teacher_dynamic_message 
			where id <#{lastId} and dynamic_id=#{dynamicId} and status=1
			order by id desc 
			limit #{pageSize}
		]]>
	</select>

	<select id="countDynamicMessage" resultType="int" parameterType="DynamicMessage">
		<![CDATA[
			select count(1)
			from teacher_dynamic_message 
			where id <#{lastId}
		]]>
	</select>

	<insert id="addDynamicMessage" useGeneratedKeys="true" keyProperty="id"  parameterType="DynamicMessage">
		insert into
		teacher_dynamic_message(
			teacher_id,
			student_id,
			dynamic_id,
			type,
			status,
			create_time,
			update_time,
			content,
			image_url,
			reply_id,
			replied_type,
			replied_user_id
		)
		values(
					#{teacherId},
					#{studentId},
					#{dynamicId},
					#{type},
					#{status},
					#{createTime},
					#{updateTime},
					#{content},
					#{imageUrl},
					#{replyId},
					#{repliedType},
					#{repliedUserId}
		)
	</insert>

	<update id="updateDynamicMessage" parameterType="DynamicMessage">
		update teacher_dynamic_message 
		set  
			  <if test="#{id}!=null and #{id}!='' ">
                	id=#{id},
              </if>
			  <if test="#{teacherId}!=null and #{teacherId}!='' ">
                	teacher_id=#{teacherId},
              </if>
			  <if test="#{studentId}!=null and #{studentId}!='' ">
                	student_id=#{studentId},
              </if>
			  <if test="#{dynamicId}!=null and #{dynamicId}!='' ">
                	dynamic_id=#{dynamicId},
              </if>
			  <if test="#{type}!=null and #{type}!='' ">
                	type=#{type},
              </if>
			  <if test="#{status}!=null and #{status}!='' ">
                	status=#{status},
              </if>
			  <if test="#{createTime}!=null and #{createTime}!='' ">
                	create_time=#{createTime},
              </if>
			  <if test="#{updateTime}!=null and #{updateTime}!='' ">
                	update_time=#{updateTime},
              </if>
			  <if test="#{content}!=null and #{content}!='' ">
                	content=#{content},
              </if>
			  <if test="#{imageUrl}!=null and #{imageUrl}!='' ">
                	image_url=#{imageUrl},
              </if>
			  <if test="#{replyId}!=null and #{replyId}!='' ">
                	reply_id=#{replyId},
              </if>
			  <if test="#{repliedType}!=null and #{repliedType}!='' ">
                	replied_type=#{repliedType},
              </if>
			  <if test="#{repliedUserId}!=null and #{repliedUserId}!='' ">
                	replied_user_id=#{repliedUserId},
              </if>
			update_time=now()
		where id=#{id}
	</update>

	<delete id="deleteDynamicMessage" parameterType="Long">
		<![CDATA[
			update teacher_dynamic_message 
			set status=0
			where id=#{value}
		]]>
	</delete>
	
	<delete id="restoreDynamicMessage" parameterType="Long">
		<![CDATA[
			update teacher_dynamic_message 
			set status=1
			where id=#{value}
		]]>
	</delete>
	
	<select id="groupCountMesasgeByDynamicIds" resultType="Dynamic" >
         select dynamic_id id,count(*) count_comment
         from teacher_dynamic_message 
         where status=1 and dynamic_id in 
			<foreach item="item" index="index" collection="list" open="(" separator="," close=")">  
			  #{item}  
			</foreach>
		 group by dynamic_id
    </select>

	<select id="isExistDynamicMessage" parameterType="DynamicMessage" resultType="int">
		<![CDATA[
			select count(1) 
			from teacher_dynamic_message  
			where name=#{name} and id!=#{id}
		]]>
	</select>
</mapper> 