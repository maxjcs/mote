<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.longcity.modeler.dao.MoteTaskDao" >
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from mote_task
    where id = #{id}
  </delete>
  <insert id="insert" parameterType="MoteTask" useGeneratedKeys="true" keyProperty="id">
    insert into mote_task ( user_id, task_id, 
      create_time, update_time, order_no, 
      express_company_id, express_no, self_buy_fee, 
      status,accepted_time)
    values (#{userId}, #{taskId}, 
      now(), now(), #{orderNo}, 
      #{expressCompanyId}, #{expressNo}, #{selfBuyFee}, 
      #{status},now())
  </insert>
  <update id="updateByPrimaryKey" parameterType="MoteTask" >
    update mote_task
    set user_id = #{userId},
      task_id = #{taskId},
      update_time = now(),
      order_no = #{orderNo},
      express_company_id = #{expressCompanyId},
      express_no = #{expressNo},
      self_buy_fee = #{selfBuyFee},
      status = #{status},
      finish_status = #{finishStatus}
    where id = #{id}
  </update>
  
  <update id="addOrderNo" >
    update mote_task
    set 
      update_time = now(),
      order_no_time = now(),
      order_no = #{orderNo},
      status = 2
    where id = #{moteTaskId}
  </update>
  
    <update id="updateStatus" >
    update mote_task
    set 
      update_time = now(),
      status = #{param2}
    where id = #{param1}
  </update>
  
  
  
  <update id="finishShowPic" >
    update mote_task
    set  
     status = 3,
     show_pic_time=now(),
     update_time = now()
    where id = #{moteTaskId}
  </update>
  
  <update id="uploadImg" >
    update mote_task
    set  
     status = 4,
     upload_pic_time=now(),
     update_time = now()
    where id = #{moteTaskId}
  </update>
  
  
  <update id="selfBuy" >
    update mote_task
    set  
     self_buy_fee = #{fee},
     status = 5,
     finish_status =1,
     self_buy_time =now(),
     update_time = now()
    where id = #{moteTaskId}
  </update>
  
  <update id="returnItem" >
    update mote_task
    set  
     express_company_id = #{expressCompanyId},
     express_no = #{expressNo},
     status = 6,
     return_item_time =now(),
     update_time = now()
    where id = #{moteTaskId}
  </update>
  
  <update id="verifyReturnItem" >
    update mote_task
    set
     self_buy_fee = #{fee},  
     status = 8,
     finish_status =1,
     update_time = now()
    where id = #{moteTaskId}
  </update>
  
  
  
  
  
  
  <select id="selectByPrimaryKey" resultType="MoteTask" parameterType="java.lang.Integer" >
    select id, user_id, task_id, create_time, update_time, order_no, express_company_id, 
    express_no, self_buy_fee, status,finish_status
    from mote_task
    where id = #{id}
  </select>
  
  <select id="stasticByTaskIds" resultType="TaskVO" parameterType="map" >
    select t.id,t.create_time,t.title,
        t.number as  total_num,
		sum(case when mt.status >=1 then 1 else 0 end) as accpeted_num,
		sum(case when mt.status >=2 then 1 else 0 end) as ordered_num,
		sum(case when mt.status >=3 then 1 else 0 end) as finish_show_num,
		sum(case when mt.status >=4 then 1 else 0 end) as upload_img_num,
		sum(case when mt.status =5 then 1 else 0 end) as self_buy_num,
		sum(case when mt.status =6 then 1 else 0 end) as return_num,
		sum(case when mt.status =7 then 1 else 0 end) as kefu_num,
		sum(case when mt.finish_status =1 then 1 else 0 end) as finished_num
    from mote_task mt,task t
	where mt.task_id=t.id and t.status=#{status}
	   and mt.task_id in 
	    <foreach item="item" index="index" collection="taskIds" open="(" separator="," close=")">  
	  			#{item}  
	    </foreach>
  </select>
  
    <select id="getMoteListByTaskId" resultType="MoteTaskVO" parameterType="map" >
	    select u.id,u.nickname,mt.order_no,mt.status,mt.finish_status from mote_task mt,user u
        where mt.user_id=u.id and mt.task_id=#{taskId}
        limit #{start},#{pageSize}
    </select>
    
  <select id="getAcceptList" resultType="MoteTask" parameterType="java.lang.Integer" >
    select *
    from mote_task
    where id > #{param1} and status = 1
    order by id asc
    limit 50
  </select>
  
  <select id="getTotalAcceptedNum" resultType="int" parameterType="java.lang.Integer" >
    select ifnull(count(1),0)
    from mote_task
    where task_id={param1} and status != 9
  </select>
  
  <select id="getMoteAcceptedNumDaily" resultType="int" parameterType="java.lang.Integer" >
    select ifnull(count(1),0)
    from mote_task
    where user_id={param1} and date(accepted_time) = curdate()
  </select>
  
  
  
  
    
    
  
  
  
  
  
</mapper>